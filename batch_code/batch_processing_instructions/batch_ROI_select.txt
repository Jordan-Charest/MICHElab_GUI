# Make copy of file before modifying (suffix _RAW to suffix _TEMP)
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_RAW.h5 copy_file D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5

# Cut ROI (mask_file path is relative to the hdf5 file location)
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 ROI_selection data/3d/dHbT,data/3d/GCaMP,data/3d/dHbO,data/3d/dHbR,data/2d/green_avg selected_dataset=data/2d/green_avg;str mask_file=../ROI_mask.npy;str

# Apply black top hat mask based on average green raw data
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 intensity_mask data/3d/dHbT,data/3d/GCaMP,data/3d/dHbO,data/3d/dHbR,data/2d/green_avg mask_path=data/2d/green_avg;str method=black_tophat;str structuring_element=5;float threshold=0.02;float dilation=0;int copy_name=None;str

# Apply intensity mask based on average green raw data
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 intensity_mask data/3d/dHbT,data/3d/GCaMP,data/3d/dHbO,data/3d/dHbR,data/2d/green_avg mask_path=data/2d/green_avg;str method=threshold;str threshold=0.08;float dilation=1;int copy_name=None;str

# Apply bandpass to hemodynamic data (Butterworth bandpass between 0.009 and 0.4 Hz; infraslow (0.009 - 0.08) + intermediate (0.08 - 0.4) frequencies)
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 bandpass data/3d/dHbT,data/3d/dHbO,data/3d/dHbR method=butter;str lowcut=0.009;float highcut=0.4;float order=3;int copy_name=None;str

# Apply bandpass to GCaMP data (Butterworth bandpass between 0.4 and 1.5 Hz; delta band (0.4 - 4) restricted by Nyquist frequency at 3 fps)
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 bandpass data/3d/GCaMP method=butter;str lowcut=0.4;float highcut=1.5;float order=3;int copy_name=None;str

# Apply gaussian time filter 
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 time_gauss_filter data/3d/GCaMP,data/3d/dHbT,data/3d/dHbO,data/3d/dHbR,data/1d/face_motion,data/1d/face_motion_lagged sigma=5;float radius=6;int

# zscore data
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 zscore data/3d/GCaMP,data/3d/dHbT,data/3d/dHbO,data/3d/dHbR

# Repack final HDF5 file to reduce size (suffix _TEMP to suffix _v2)
D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_TEMP.h5 repack_file D:\mouse_data\new_data\M{mouse_num}\formatted\M{mouse_num}_v2.h5